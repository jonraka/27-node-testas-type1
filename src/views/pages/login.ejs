<%- include('../partials/head') %>

<main>
    <div class="container">
        <form
            id="form"
            method="post"
            action="login"
            class="d-flex flex-column mw-500 mg-center"
        >
            <label for="email" class="mg-top-5">Email</label>
            <input type="email" name="email" id="email" required />
            <label for="password" class="mg-top-5">Password</label>
            <input
                type="password"
                name="password"
                id="password"
                minlength="5"
                maxlength="50"
                required
            />
            <input type="submit" value="Login" class="mg-top-5" />
            <p>Or <a href="register">Sign Up</a></p>
            <div id="warnings" class="warning mg-top-5"></div>
        </form>
    </div>
</main>

<script>
    const emailRegex =
        /(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:(2(5[0-5]|[0-4][0-9])|1[0-9][0-9]|[1-9]?[0-9]))\.){3}(?:(2(5[0-5]|[0-4][0-9])|1[0-9][0-9]|[1-9]?[0-9])|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])/;
    const formEl = document.getElementById('form');
    const emailEl = document.getElementById('email');
    const passwordEl = document.getElementById('password');
    const warningEl = document.getElementById('warnings');

    const urlParams = new URLSearchParams(window.location.search);
    const didJustRegisterParam = urlParams.get('registered');
    if (didJustRegisterParam) {
        warningEl.innerText = 'Account created, please sign in.';
    }
    const errorsParam = urlParams.get('error');
    if (errorsParam) {
        warningEl.innerText = errorsParam;
        emailEl.value = sessionStorage.getItem('login_email') || '';
    }

    formEl.addEventListener('submit', (e) => {
        e.preventDefault();
        const errors = [];

        if (emailEl.value.length < 4 || !emailRegex.test(emailEl.value)) {
            errors.push('Invalid email');
        }
        if (passwordEl.value.length < 5 || passwordEl.value.length > 50) {
            errors.push('Invalid password, must be between 5 and 50');
        }

        if (errors.length) {
            warningEl.innerText = errors.join('\n');
        } else {
            sessionStorage.setItem('login_email', emailEl.value);
            formEl.submit();
        }
    });
</script>

<%- include('../partials/foot') %>
